---
title: "From Spreadsheets to R - without going too far"
subtitle: "Part 3 - Plotting your data"
output: html_document
editor_options: 
  chunk_output_type: console
---

*This is an R-markdown document. If run in RStudio, you will see code blocks appear with the option to run each one using the little "play button" on the top-right of each block. The output (including errors) will be printed below a block. For the best view, click the `Visual` mode at the top left of this file (if set to Source now)*

Read the [session materials](README.md) for more background on the various functions and their use

## Make sure you have the following libraries loaded

```{r setup, include=FALSE}
library(knitr)
library(readxl)
library(dplyr)
library(ggplot2)
library(stringr)

opts_chunk$set(echo = TRUE)

#install.packages(c("tidyverse", "knitr"))

```

If you get an error that libraries are not installed yet, un-comment the last line (remove the `#`), and run the code block again (you can re-comment once installed).

# Exploring the data

## Read in an Excel file

Let's load in an Excel file (antiquities_act.xlsx) which is stored in the same folder as this script using the `read_excel` function and assigning it to a variable named `data`

```{r}
data <- read_xlsx("data/actions_under_antiquities_act_cleaned.xlsx")

# Make sure the action column only has values established, enlarged and diminished.
data <- data |> mutate(action = case_when(
  str_detect(action, "Established") ~ "established",
  str_detect(action, "Enlarged") ~ "enlarged",
  str_detect(action, "Diminished") ~ "diminished",
  TRUE ~ "other"
)) |> filter(action != "other")

# Make sure if an area is diminished the values becomes negative
data <- data |> mutate(
  acres_affected = ifelse(action == "diminished", -acres_affected, acres_affected),
  square_miles = acres_affected / 640
  )

```

# Mapping dataframe columns to plot aesthetics

```{r}
plotData <- data |>
  group_by(year) |>
  summarise(
    square_miles = sum(square_miles),
    n_actions = n()) |> 
  ungroup() |>
  filter(square_miles < 25000) 
```
_We'll look at the cases where the total square mile added per year was less than 25,000_

We'll put the year on the x-axis and the affected acres on the y-axis

```{r}
myPlot <- ggplot(plotData, aes(x = year, y = square_miles))
myPlot
```

*Note that when the plot is rendered, no data points are shown yet because we have not defined the exact type of plot yet*

# Visualising data points - geom\_\*()

Let's start by showing the data as points (i.e. a scatter plot)

```{r}
myPlot + geom_point()
```

We can use the same ggplot object to show the data as a line chart

```{r}
myPlot + geom_line()
```


### Try it yourself

We'll be working with a dataset that comes with R called `iris` which has a record of several plant characteristics for different iris species

```{r}
myData <- iris
glimpse(myData)
```

#### Make a scatter plot (points) of the petal length vs the width

```{r}
myPlot <- ggplot(myData, aes(x = Petal.Length, y = Petal.Width)) + 
  geom_point()
myPlot
```

#### Turn the same plot into a line chart

```{r}
myPlot <- ggplot(myData, aes(x = Petal.Length, y = Petal.Width)) + 
  geom_line()
myPlot
```

*Although it renders, why is this not a good chart type for this data?*

#Static vs data-driven attributes

Depending on the data we have and what we want to visualise, we can have either set some attributes for the whole plot or have them be driven by the data.

## Global / static attribute

Change the size of the points in the plot
```{r}
myPlot <- ggplot(plotData, aes(x = year, y = square_miles)) +
  geom_point(size = 2)
myPlot
```
_Defining an attribute outside of the aes() function in the geom function will set it for all the data points_

## Data driven point size

Change the size based on a column value
```{r}
myPlot <- ggplot(plotData, aes(x = year, y = square_miles, size = n_actions)) +
  geom_point()
myPlot
```
_Not that the size of the point is now defined by the value of n_actions and a legend appears_

### Try it yourself

#### Continue from the last iris scatter plot and colour all the points blue
```{r}
ggplot(myData, aes(x = Petal.Length, y = Petal.Width)) + 
  geom_point(color = "blue")
```
_You can either provide the name of the colour like "blue" or a hex value like "#1273ed"_

#### Now change this so that each species had a different colour
```{r}
ggplot(myData, aes(x = Petal.Length, y = Petal.Width, colour = Species)) + 
  geom_point()
```
_ggplot will automatically generate colours for different species names_

## Plot layout

### Add labels
```{r}
myPlot <- ggplot(plotData, aes(x = year, y = square_miles, size = n_actions)) +
  geom_point() +
  labs(x = "Year action was passed in congress", 
       y = "Square miles added", 
       title = "Fedaral acres added under the antiquities act in years where\n there were less than 25,000 square miles acres affected"
       )
myPlot
```
_Add axis labels and a title to the plot_

### Change theme
```{r}
myPlot <- ggplot(plotData, aes(x = year, y = square_miles, size = n_actions)) +
  geom_point() +
  labs(x = "Year action was passed in congress", 
       y = "Square miles added", 
       title = "Fedaral acres added under the antiquities act in years where\n there were less than 25,000 square miles acres affected"
       ) +
  theme_bw()
myPlot
```
_Use a built-in black and white theme_

### Try it yourself

#### Continue from the last iris scatter plot: update the axis labels and add a title

- Title: Iris petal length and width comparison for different species
- x label: Petal length (cm)
- y label: Petal width (cm)
```{r}
ggplot(myData, aes(x = Petal.Length, y = Petal.Width, colour = Species)) + 
  geom_point() + labs(x = "Petal length (cm)", y = "Petal width (cm)", 
                      title = "Iris petal length and width comparison for different species")
```

#### Now add built-in minimal theme to the plot `theme_minimal()` 
```{r}
ggplot(myData, aes(x = Petal.Length, y = Petal.Width, colour = Species)) + 
  geom_point() + labs(
    x = "Petal length", 
    y = "Petal width",
    title = "Iris petal length and width comparison for different species") + theme_minimal()
```

## Bar charts

When creating bar charts with ggplot you have two options depending on the current shape of the data

### Data has already been summarised
```{r}
sumData <- data |>
  group_by(year) |>
  summarise(
    square_miles = sum(square_miles),
    n_actions = n()) |> 
  ungroup()
```

```{r}
myPlot <- ggplot(sumData, aes(x = year, y = square_miles)) +
  geom_bar(stat = "identity")
myPlot
```
_In this case (identity) the acres_affected were already summarised by year and we just need to plot them_

### Data is not summarised

```{r}
myPlot <- ggplot(data, aes(x = year, y = square_miles)) +
  geom_bar(stat = "sum")
myPlot
```
_In this case the acres affected need to be summarised by year by ggplot before being plotted_

## Examples of additional ggplot functions

Looking at the last plot, we see that the 1978 bar overshadows all the others. We can deal with this in two ways:

1) Filter the data: we did this in the previous plots limiting to 1 million acres per year
2) Change the scale: make the scale logarithmic

```{r}
myPlot <- ggplot(data, aes(x = year, y = square_miles)) +
  geom_bar(stat = "sum") +
  scale_y_log10()
myPlot
```

